apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  creationTimestamp: null
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-static-pod-check-workaround-master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKIwojIFBlcmlvZGljYWxseSBjaGVja3Mgc3RhdGljIHBvZCBjb250YWluZXIgc3RhdGVzLgojIElmIHVuaGVhbHRoeSBmb3IgYSBwZXJpb2Qgb2YgdGltZSwgcmVzdGFydCBrdWJlbGV0LnNlcnZpY2UKIwoKUFJPRz0kKGJhc2VuYW1lICIkMCIpCgojIFRhZyBmb3IgbG9ncyBpbiBqb3VybmFsZApkZWNsYXJlIGxvZ3RhZz0ic3RhdGljLXBvZC1jaGVjay13b3JrYXJvdW5kIgoKIyBEZWJ1ZyBsb2dzCmRlY2xhcmUgdmVyYm9zZT0ibm8iCgojIExvZyB0byBzdGRvdXQgaW5zdGVhZCBvZiBqb3VybmFsZApkZWNsYXJlIGxvZ190b19zdGRvdXQ9Im5vIgoKIyBMb2NhdGlvbiBvZiBzdGF0aWMgcG9kIG1hbmlmZXN0cwpkZWNsYXJlIG1hbmlmZXN0c19kaXI9Ii9ldGMva3ViZXJuZXRlcy9tYW5pZmVzdHMiCgojIE1pbmltdW0gdGltZSBrdWJlbGV0IHNob3VsZCBiZSBhY3RpdmUgYmVmb3JlIHdlIGNoZWNrIHN0YXRlcwpkZWNsYXJlIGt1YmVsZXRfdXBfbWluaW11bV9zZWNzPTEyMDAKCiMgVGltZSBiZXR3ZWVuIGNoZWNrcyB3aGVuIHN0YXRpYyBwb2RzIGFyZSBoZWFsdGh5CmRlY2xhcmUgaW50ZXJ2YWxfaGVhbHRoeV9zZWNzPTMwMAoKIyBUaW1lIGJldHdlZW4gY2hlY2tzIHdoZW4gc3RhdGljIHBvZHMgYXJlIHVuaGVhbHRoeQpkZWNsYXJlIGludGVydmFsX3VuaGVhbHRoeV9zZWNzPTMwCgojIE51bWJlciBvZiBmYWlsZWQgaGVhbHRoIGNoZWNrcyBmb3IgYSBnaXZlbiBwb2QgYmVmb3JlIHJlc3RhcnRpbmcga3ViZWxldApkZWNsYXJlIG1heF9jb25zZWN1dGl2ZV9mYWlsdXJlcz0yMAoKIyBGb3IgdGVzdGluZywgZm9yY2UgaGVhbHRoIGNoZWNrIGZhaWx1cmUgYnkgY3JlYXRpbmcgdGhpcyBmbGFnIGZpbGUKZGVjbGFyZSB0ZXN0X2ZhaWx1cmVfZmxhZ19maWxlPS90bXAvZm9yY2Vfc3RhdGljX3BvZF9jaGVja19mYWlsdXJlLmZsYWcKCiMgRm9yIHRlc3RpbmcsIGFsbG93IGRyeS1ydW4gdG8gb25seSBsb2cKZGVjbGFyZSBkcnlydW49Im5vIgoKIyBBc3NvY2lhdGl2ZSBhcnJheSBmb3IgdHJhY2tpbmcgY29uc2VjdXRpdmUgZmFpbHVyZXMKZGVjbGFyZSAtQSBoZWFsdGhfZmFpbHVyZXMKCiMKIyBMb2dnaW5nIGZ1bmN0aW9ucwojCmZ1bmN0aW9uIGxvZ2luZm8gewogICAgaWYgWyAiJHtsb2dfdG9fc3Rkb3V0fSIgPSAibm8iIF07IHRoZW4KICAgICAgICBsb2dnZXIgLXQgIiR7bG9ndGFnfSIgLS1pZD0kQkFTSFBJRCAiJDEiCiAgICBlbHNlCiAgICAgICAgZWNobyAiJChkYXRlKTogJDEiCiAgICBmaQp9CgpmdW5jdGlvbiBsb2dkZWJ1ZyB7CiAgICBpZiBbICIke3ZlcmJvc2V9IiA9ICJubyIgXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKCiAgICBpZiBbICIke2xvZ190b19zdGRvdXR9IiA9ICJubyIgXTsgdGhlbgogICAgICAgIGxvZ2dlciAtdCAiJHtsb2d0YWd9IiAtLWlkPSRCQVNIUElEICIkMSIKICAgIGVsc2UKICAgICAgICBlY2hvICIkKGRhdGUpOiAkMSIKICAgIGZpCn0KCiMKIyBWZXJpZnkga3ViZWxldCBoYXMgYmVlbiBydW5uaW5nIGZvciBhdCBsZWFzdCBrdWJlbGV0X3VwX21pbmltdW1fc2VjcyBzZWNvbmRzCiMKZnVuY3Rpb24ga3ViZWxldF9ydW5uaW5nIHsKICAgIGlmICEgc3lzdGVtY3RsIC1xIGlzLWFjdGl2ZSBrdWJlbGV0LnNlcnZpY2UgOyB0aGVuCiAgICAgICAgbG9nZGVidWcgImt1YmVsZXQuc2VydmljZSBpcyBub3QgYWN0aXZlIgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIGt1YmVsZXRfc3RhcnRfdGltZQogICAgbG9jYWwga3ViZWxldF9zdGFydF90aW1lX3NlY3MKICAgIGxvY2FsIHNlY3Nfc2luY2Vfc3RhcnQKCiAgICBrdWJlbGV0X3N0YXJ0X3RpbWU9JChzeXN0ZW1jdGwgc2hvdyBrdWJlbGV0LnNlcnZpY2UgLS1uby1wYWdlIHwgYXdrIC1GJz0nICckMSA9PSAiQWN0aXZlRW50ZXJUaW1lc3RhbXAiIHsgcHJpbnQgJDJ9JykKICAgIGt1YmVsZXRfc3RhcnRfdGltZV9zZWNzPSQoZGF0ZSAtLWRhdGU9IiR7a3ViZWxldF9zdGFydF90aW1lfSIgKyVzKQogICAgc2Vjc19zaW5jZV9zdGFydD0kKCgkKGRhdGUgKyVzKS1rdWJlbGV0X3N0YXJ0X3RpbWVfc2VjcykpCgogICAgaWYgWyAiJHtzZWNzX3NpbmNlX3N0YXJ0fSIgLWx0ICIke2t1YmVsZXRfdXBfbWluaW11bV9zZWNzfSIgXTsgdGhlbgogICAgICAgIGxvZ2RlYnVnICJrdWJlbGV0LnNlcnZpY2UgcnVubmluZyBvbmx5ICR7c2Vjc19zaW5jZV9zdGFydH0gc2Vjb25kcyAobWluaW11bSAke2t1YmVsZXRfdXBfbWluaW11bV9zZWNzfSkiCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgcmV0dXJuIDAKfQoKIwojIFZlcmlmeSB0aGF0IGVhY2ggY29udGFpbmVyIGluIGNvbmZpZ3VyZWQgc3RhdGljIHBvZHMgYXJlIGluIGEgcnVubmluZyBzdGF0ZQojCmZ1bmN0aW9uIGNoZWNrX3N0YXRpY19wb2RfY29udGFpbmVyX2hlYWx0aCB7CiAgICBsb2NhbCBjdXJyZW50X3BzX291dHB1dAogICAgbG9jYWwgZgogICAgbG9jYWwgbmFtZQogICAgbG9jYWwgc3RhdGUKICAgIGxvY2FsIGZhaWx1cmVzPTAKCiAgICBjdXJyZW50X3BzX291dHB1dD0kKGNyaWN0bCBwcyAtbyBqc29uIDI+L2Rldi9udWxsKQogICAgZm9yIGYgaW4gIiR7bWFuaWZlc3RzX2Rpcn0iLyoueWFtbCA7IGRvCiAgICAgICAgaWYgWyAhIC1mICIke2Z9IiBdOyB0aGVuCiAgICAgICAgICAgIGxvZ2luZm8gIlN0YXRpYyBwb2QgbWFuaWZlc3Qgbm90IGZvdW5kOiAke21hbmlmZXN0c19kaXJ9IgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGZpCgogICAgICAgICMgR2V0IGNvbnRhaW5lciBzdGF0ZSBvZiBzeXN0ZW0tbm9kZS1jcml0aWNhbCBwb2RzCiAgICAgICAgZm9yIG5hbWUgaW4gJChqcSAtciAnc2VsZWN0KC5zcGVjLnByaW9yaXR5Q2xhc3NOYW1lPT0ic3lzdGVtLW5vZGUtY3JpdGljYWwiKSB8IC5zcGVjLmNvbnRhaW5lcnNbXS5uYW1lJyAkZik7IGRvCiAgICAgICAgICAgIHN0YXRlPSQoZWNobyAiJHtjdXJyZW50X3BzX291dHB1dH0iIHwganEgLXIgLS1hcmcgbmFtZSAiJHtuYW1lfSIgJy5jb250YWluZXJzW10gfCBzZWxlY3QoLm1ldGFkYXRhLm5hbWU9PSRuYW1lKS5zdGF0ZScpCiAgICAgICAgICAgIGlmIFsgIiR7c3RhdGV9IiAhPSAiQ09OVEFJTkVSX1JVTk5JTkciIF07IHRoZW4KICAgICAgICAgICAgICAgIGlmIFsgLXogIiR7c3RhdGV9IiBdOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgbG9naW5mbyAiJHtuYW1lfSBpcyBub3QgZm91bmQgaW4gY3JpY3RsIHBzIG91dHB1dCIKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBsb2dpbmZvICIke25hbWV9IGlzIG5vdCBydW5uaW5nOiBzdGF0ZT0ke3N0YXRlfSIKICAgICAgICAgICAgICAgIGZpCgogICAgICAgICAgICAgICAgZmFpbHVyZXM9JCgoZmFpbHVyZXMrMSkpCiAgICAgICAgICAgICAgICBoZWFsdGhfZmFpbHVyZXNbIiR7bmFtZX0iXT0kKCgke2hlYWx0aF9mYWlsdXJlc1siJHtuYW1lfSJdfSsxKSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGhlYWx0aF9mYWlsdXJlc1siJHtuYW1lfSJdPTAKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCiAgICBkb25lCgogICAgaWYgWyAtZiAiJHt0ZXN0X2ZhaWx1cmVfZmxhZ19maWxlfSIgXTsgdGhlbgogICAgICAgIGxvY2FsIHRlc3RuYW1lCiAgICAgICAgIyBzaGVsbGNoZWNrIGRpc2FibGU9U0MyMDEzCiAgICAgICAgZm9yIHRlc3RuYW1lIGluICQoY2F0ICIke3Rlc3RfZmFpbHVyZV9mbGFnX2ZpbGV9Iik7IGRvCiAgICAgICAgICAgIGhlYWx0aF9mYWlsdXJlc1siJHt0ZXN0bmFtZX0iXT0kKCgke2hlYWx0aF9mYWlsdXJlc1siJHt0ZXN0bmFtZX0iXX0rMSkpCiAgICAgICAgICAgIGZhaWx1cmVzPSQoKGZhaWx1cmVzKzEpKQogICAgICAgICAgICBsb2dpbmZvICJUZXN0aW5nIGZhaWx1cmUgd2l0aCAke3Rlc3RfZmFpbHVyZV9mbGFnX2ZpbGV9IHByZXNlbmNlOiAke3Rlc3RuYW1lfTogJHtoZWFsdGhfZmFpbHVyZXNbJHt0ZXN0bmFtZX1dfSIKICAgICAgICBkb25lCiAgICBmaQoKICAgIHJldHVybiAiJHtmYWlsdXJlc30iCn0KCiMKIyBDaGVjayBoZWFsdGhfZmFpbHVyZXMgYXJyYXkgdG8gc2VlIGlmIGFueSBwb2RzIGhhdmUgcmVhY2hlZCBtYXhpbXVtIGNvbnNlY3V0aXZlIGZhaWx1cmVzCiMKZnVuY3Rpb24gY2hlY2tfaGVhbHRoX2ZhaWx1cmVzIHsKICAgIGxvY2FsIG5hbWUKICAgIGxvY2FsIHJjPTAKICAgIGZvciBuYW1lIGluICIkeyFoZWFsdGhfZmFpbHVyZXNbQF19IjsgZG8KICAgICAgICBpZiBbICIke2hlYWx0aF9mYWlsdXJlc1ske25hbWV9XX0iIC1nZSAiJHttYXhfY29uc2VjdXRpdmVfZmFpbHVyZXN9IiBdOyB0aGVuCiAgICAgICAgICAgIGxvZ2luZm8gIiR7bmFtZX0gaGFzIHJlYWNoZWQgbWF4aW11bSBjb25zZWN1dGl2ZSBmYWlsdXJlcyAoJHtoZWFsdGhfZmFpbHVyZXNbJHtuYW1lfV19IgogICAgICAgICAgICByYz0kKChyYysxKSkKICAgICAgICBmaQogICAgZG9uZQoKICAgIHJldHVybiAiJHtyY30iCn0KCiMKIyBSdW4gdGhlIGNvbnRhaW5lciBwb2QgY2hlY2ssIHdpdGggbGltaXRlZCByZXRyaWVzIGluIGZhaWx1cmUgc2NlbmFyaW8KIwpmdW5jdGlvbiBydW5fY2hlY2sgewogICAgd2hpbGUgISBjaGVja19zdGF0aWNfcG9kX2NvbnRhaW5lcl9oZWFsdGg7IGRvCiAgICAgICAgaWYgISBjaGVja19oZWFsdGhfZmFpbHVyZXM7IHRoZW4KICAgICAgICAgICAgbG9naW5mbyAic3RhdGljIHBvZCBjb250YWluZXJzIHVuaGVhbHRoeSBmb3IgdG9vIGxvbmciCiAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgZmkKCiAgICAgICAgc2xlZXAgIiR7aW50ZXJ2YWxfdW5oZWFsdGh5X3NlY3N9IgogICAgZG9uZQoKICAgICMgUmVzZXQgaGVhbHRoX2ZhaWx1cmVzCiAgICBoZWFsdGhfZmFpbHVyZXM9KCkKCiAgICBsb2dkZWJ1ZyAic3RhdGljIHBvZCBjb250YWluZXJzIGhlYWx0aHkiCiAgICByZXR1cm4gMAp9CgojCiMgVXNhZ2UKIwpmdW5jdGlvbiB1c2FnZSB7CiAgICBjYXQgPDxFT0YKVXNhZ2U6ICR7UFJPR30KT3B0aW9uczoKICAgIC0tZHJ5cnVuIHwgLW4gICAgICAgICAgICAgICAgIERyeSBydW4gKGRvbid0IHJlc3RhcnQga3ViZWxldCwgbG9nIG9ubHkpCiAgICAtLXZlcmJvc2UgfCAtdiAgICAgICAgICAgICAgICBUdXJuIG9uIGRlYnVnIGxvZ3MKICAgIC0tbG9nLXRvLXN0ZG91dCAgICAgICAgICAgICAgIExvZyB0byBzdGRvdXQgaW5zdGVhZCBvZiBqb3VybmFsZAogICAgLS1tYW5pZmVzdHMtZGlyIHwgLW0gICAgICAgICAgTG9jYXRpb24gb2Ygc3RhdGljIHBvZCBtYW5pZmVzdHMgKGRlZmF1bHQ6IC9ldGMva3ViZXJuZXRlcy9tYW5pZmVzdHMpCiAgICAtLWt1YmVsZXQtdXAtbWluIDxzZWNzPiAgICAgICBNaW5pbXVtIHRpbWUsIGluIHNlY29uZHMsIGt1YmVsZXQgbXVzdCBiZSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZSBhbGxvd2luZyBoZWFsdGggY2hlY2tzIHRvIHJ1biAoZGVmYXVsdDogMTIwMCkKICAgIC0taGVhbHRoeS1pbnRlcnZhbCA8c2Vjcz4gICAgIEludGVydmFsIGJldHdlZW4gY2hlY2tzLCBpbiBzZWNvbmRzLCB3aGVuIHN0YXRpYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9kcyBhcmUgaGVhbHRoeSAoZGVmYXVsdDogMzAwKQogICAgLS11bmhlYWx0aHktaW50ZXJ2YWwgPHNlY3M+ICAgSW50ZXJ2YWwgYmV0d2VlbiBjaGVja3MsIGluIHNlY29uZHMsIHdoZW4gc3RhdGljCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2RzIGFyZSB1bmhlYWx0aHkgKGRlZmF1bHQ6IDMwKQogICAgLS1tYXgtZmFpbHVyZXMgPGludD4gICAgICAgICAgTWF4aW11bSBjb25zZWN1dGl2ZSBoZWFsdGggY2hlY2sgZmFpbHVyZXMgZm9yIGFueSBnaXZlbiBwb2QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZSByZXN0YXJ0aW5nIGt1YmVsZXQgKGRlZmF1bHQ6IDIwKQpFT0YKICAgIGV4aXQgMQp9CgojCiMgUHJvY2VzcyBjbWRsaW5lIGFyZ3VtZW50cwojCgpsb25nb3B0cz0oCiAgICAiaGVscCIKICAgICJkcnlydW4iCiAgICAidmVyYm9zZSIKICAgICJsb2ctdG8tc3Rkb3V0IgogICAgIm1hbmlmZXN0cy1kaXI6IgogICAgImt1YmVsZXQtdXAtbWluOiIKICAgICJoZWFsdGh5LWludGVydmFsOiIKICAgICJ1bmhlYWx0aHktaW50ZXJ2YWw6IgogICAgIm1heC1mYWlsdXJlczoiCikKCmxvbmdvcHRzX3N0cj0kKElGUz0sOyBlY2hvICIke2xvbmdvcHRzWypdfSIpCgppZiAhIE9QVFM9JChnZXRvcHQgLW8gImh2bm06IiAtLWxvbmcgIiR7bG9uZ29wdHNfc3RyfSIgLS1uYW1lICIkMCIgLS0gIiRAIik7IHRoZW4KICAgIHVzYWdlCiAgICBleGl0IDEKZmkKCmV2YWwgc2V0IC0tICIke09QVFN9IgoKd2hpbGUgOjsgZG8KICAgIGNhc2UgIiQxIiBpbgogICAgICAgIC12fC0tdmVyYm9zZSkKICAgICAgICAgICAgdmVyYm9zZT0ieWVzIgogICAgICAgICAgICBzaGlmdAogICAgICAgICAgICA7OwogICAgICAgIC1ufC0tZHJ5cnVuKQogICAgICAgICAgICBkcnlydW49InllcyIKICAgICAgICAgICAgc2hpZnQKICAgICAgICAgICAgOzsKICAgICAgICAtLWxvZy10by1zdGRvdXQpCiAgICAgICAgICAgIGxvZ190b19zdGRvdXQ9InllcyIKICAgICAgICAgICAgc2hpZnQKICAgICAgICAgICAgOzsKICAgICAgICAtbXwtLW1hbmlmZXN0cy1kaXIpCiAgICAgICAgICAgIG1hbmlmZXN0c19kaXI9IiR7Mn0iCiAgICAgICAgICAgIHNoaWZ0IDIKICAgICAgICAgICAgOzsKICAgICAgICAtLWt1YmVsZXQtdXAtbWluKQogICAgICAgICAgICBrdWJlbGV0X3VwX21pbmltdW1fc2Vjcz0iJHsyfSIKICAgICAgICAgICAgc2hpZnQgMgogICAgICAgICAgICA7OwogICAgICAgIC0taGVhbHRoeS1pbnRlcnZhbCkKICAgICAgICAgICAgaW50ZXJ2YWxfaGVhbHRoeV9zZWNzPSIkezJ9IgogICAgICAgICAgICBzaGlmdCAyCiAgICAgICAgICAgIDs7CiAgICAgICAgLS11bmhlYWx0aHktaW50ZXJ2YWwpCiAgICAgICAgICAgIGludGVydmFsX3VuaGVhbHRoeV9zZWNzPSIkezJ9IgogICAgICAgICAgICBzaGlmdCAyCiAgICAgICAgICAgIDs7CiAgICAgICAgLS1tYXgtZmFpbHVyZXMpCiAgICAgICAgICAgIG1heF9jb25zZWN1dGl2ZV9mYWlsdXJlcz0iJHsyfSIKICAgICAgICAgICAgc2hpZnQgMgogICAgICAgICAgICA7OwogICAgICAgIC0tKQogICAgICAgICAgICBzaGlmdAogICAgICAgICAgICBicmVhawogICAgICAgICAgICA7OwogICAgICAgIC1ofC0taGVscCkKICAgICAgICAgICAgdXNhZ2UKICAgICAgICAgICAgOzsKICAgICAgICAqKQogICAgICAgICAgICB1c2FnZQogICAgICAgICAgICA7OwogICAgZXNhYwpkb25lCgojCiMgUnVuIGhlYWx0aCBjaGVjawojCndoaWxlIDo7IGRvCiAgICBpZiBrdWJlbGV0X3J1bm5pbmcgJiYgISBydW5fY2hlY2sgOyB0aGVuCiAgICAgICAgaWYgWyAiJHtkcnlydW59IiA9ICJubyIgXTsgdGhlbgogICAgICAgICAgICBsb2dpbmZvICJSZXN0YXJ0aW5nIGt1YmVsZXQuc2VydmljZSIKICAgICAgICAgICAgc3lzdGVtY3RsIHJlc3RhcnQga3ViZWxldC5zZXJ2aWNlCiAgICAgICAgZWxzZQogICAgICAgICAgICBsb2dpbmZvICJIZWFsdGggY2hlY2sgZmFpbGVkIChkcnlydW4gb25seSwgbm90IHJlc3RhcnRpbmcga3ViZWxldCkiCiAgICAgICAgZmkKCiAgICAgICAgIyBSZXNldCBoZWFsdGhfZmFpbHVyZXMKICAgICAgICBoZWFsdGhfZmFpbHVyZXM9KCkKICAgIGZpCgogICAgc2xlZXAgIiR7aW50ZXJ2YWxfaGVhbHRoeV9zZWNzfSIKZG9uZQoK
        mode: 484
        overwrite: true
        path: /usr/local/bin/static-pod-check-workaround.sh
        user:
          name: root
    systemd:
      units:
      - contents: '[Unit]

          Description=Check for stuck static pod revisions

          After=kubelet.service


          [Service]

          Type=simple

          User=root

          ExecStart=/usr/local/bin/static-pod-check-workaround.sh -v --max-failures
          30


          [Install]

          WantedBy=multi-user.target

          '
        enabled: true
        name: static-pod-check-workaround.service
